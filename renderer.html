<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>3D 场景渲染器</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body {
            margin: 0;
            overflow: hidden;
            font-family: 'Inter', sans-serif;
            background-color: #111827;
            color: white;
        }
        #scene-container {
            position: absolute;
            top: 0;
            left: 0;
            width: 100vw;
            height: 100vh;
        }
        #instructions {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            text-align: center;
            padding: 2rem;
            background-color: rgba(0, 0, 0, 0.7);
            border-radius: 1rem;
            max-width: 90%;
            pointer-events: none;
            z-index: 10;
        }
        #settings-panel {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            padding: 2rem;
            background-color: rgba(31, 41, 55, 0.95);
            border: 1px solid rgba(75, 85, 99, 0.5);
            border-radius: 1rem;
            width: 90%;
            max-width: 400px;
            display: none;
            z-index: 20;
            box-shadow: 0 10px 25px rgba(0,0,0,0.5);
        }
        .slider-container { margin-bottom: 1.5rem; }
        .slider-container label { display: block; margin-bottom: 0.5rem; color: #d1d5db; }
        input[type="range"] { width: 100%; accent-color: #3b82f6; }
        input[type="color"] { width: 100%; height: 40px; border: none; padding: 0; border-radius: 0.25rem; cursor: pointer; }
        #file-upload-button { position: absolute; bottom: 2rem; left: 50%; transform: translateX(-50%); z-index: 15; }
        #error-message { position: absolute; bottom: 6rem; left: 50%; transform: translateX(-50%); background-color: #ef4444; color: white; padding: 0.5rem 1rem; border-radius: 0.5rem; display: none; z-index: 30; }
        #grayscale-preview {
            position: absolute;
            bottom: 1rem;
            right: 1rem;
            /* 更新预览窗口的CSS尺寸 */
            width: 188px;
            height: 120px;
            border: 2px solid #4b5563;
            border-radius: 0.5rem;
            background-color: #1f2937;
            z-index: 15;
            display: none; /* Initially hidden */
        }
    </style>
</head>
<body>
    <!-- 3D场景的容器 -->
    <div id="scene-container"></div>
    <!-- 灰度图预览画布 -->
    <canvas id="grayscale-preview"></canvas>
    <!-- 用户操作指引 -->
    <div id="instructions">
        <h2 class="text-2xl font-bold mb-4">欢迎使用3D场景渲染器</h2>
        <p class="mb-2">1. 点击下方按钮上传一张图片作为地面。</p>
        <p class="mb-2">2. 点击屏幕锁定鼠标，然后：</p>
        <ul class="list-disc list-inside text-left mx-auto max-w-xs">
            <li><span class="font-bold">移动鼠标</span>: 调整视角</li>
            <li><span class="font-bold">W/A/S/D</span>: 前/左/后/右 移动</li>
            <li><span class="font-bold">空格</span>: 上升</li>
            <li><span class="font-bold">Shift</span>: 下降</li>
        </ul>
        <p class="mt-4">按 <span class="font-bold bg-gray-700 px-2 py-1 rounded">' I '</span> 键打开/关闭设置菜单。</p>
        <p class="mt-2">按 <span class="font-bold bg-gray-700 px-2 py-1 rounded">' Esc '</span> 键解锁鼠标。</p>
    </div>
    <!-- 文件上传按钮 -->
    <input type="file" id="image-input" accept="image/*" style="display: none;">
    <button id="file-upload-button" class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded-lg shadow-lg transition-transform transform hover:scale-105">上传地面图片</button>
    <!-- 错误消息提示 -->
    <div id="error-message"></div>
    <!-- 设置面板 -->
    <div id="settings-panel">
        <h3 class="text-xl font-bold mb-6 text-center">设置</h3>
        <div class="slider-container">
            <label for="tiling-slider">地面图片平铺: <span id="tiling-value">50</span>x</label>
            <input id="tiling-slider" type="range" min="1" max="500" step="1" value="50">
        </div>
        <div class="slider-container">
            <label for="fov-slider">镜头视野 (FOV): <span id="fov-value">75</span>°</label>
            <input id="fov-slider" type="range" min="30" max="120" step="1" value="75">
        </div>
        <div class="slider-container">
            <label for="light-slider">光照强度: <span id="light-value">1.5</span></label>
            <input id="light-slider" type="range" min="0" max="5" step="0.1" value="1.5">
        </div>
        <div class="slider-container">
            <label for="color-picker">背景颜色</label>
            <input id="color-picker" type="color" value="#111827">
        </div>
        <!-- 实时数据流模块 -->
        <hr class="border-gray-600 my-6">
        <h4 class="text-lg font-bold mb-4 text-center">实时数据流 (WebSocket)</h4>
        <div class="slider-container">
            <label for="ws-url-input">服务器地址:</label>
            <input id="ws-url-input" type="text" value="ws://localhost:8765" class="w-full bg-gray-700 border border-gray-600 rounded px-3 py-2 text-white">
        </div>
        <p class="text-sm text-center text-gray-400 mb-4">状态: <span id="ws-status" class="font-bold text-red-400">未连接</span></p>
        <button id="ws-connect-btn" class="w-full bg-green-600 hover:bg-green-700 text-white font-bold py-2 px-4 rounded-lg">连接</button>
        <hr class="border-gray-600 my-6">
        <button id="close-settings" class="w-full bg-gray-600 hover:bg-gray-700 text-white font-bold py-2 px-4 rounded-lg">关闭 (按 'I' 键)</button>
    </div>
    <!-- Three.js -->
    <script async src="https://unpkg.com/es-module-shims@1.6.3/dist/es-module-shims.js"></script>
    <script type="importmap"> { "imports": { "three": "https://cdn.jsdelivr.net/npm/three@0.157.0/build/three.module.js", "three/addons/": "https://cdn.jsdelivr.net/npm/three@0.157.0/examples/jsm/" } } </script>
    <script type="module">
        import * as THREE from 'three';
        import { PointerLockControls } from 'three/addons/controls/PointerLockControls.js';
        // --- 核心变量 ---
        let scene, camera, renderer, controls, floor, floorTexture, ambientLight, directionalLight;
        // --- 移动状态 ---
        const moveState = { forward: false, backward: false, left: false, right: false, up: false, down: false };
        const velocity = new THREE.Vector3();
        const direction = new THREE.Vector3();
        const moveSpeed = 50.0;
        // --- 数据流变量 ---
        let socket;
        let isStreaming = false;
        const processCanvas = document.createElement('canvas');
        const processCtx = processCanvas.getContext('2d', { willReadFrequently: true });
        // *** 更新数据流尺寸 ***
        const STREAM_WIDTH = 188;
        const STREAM_HEIGHT = 120;
        processCanvas.width = STREAM_WIDTH;
        processCanvas.height = STREAM_HEIGHT;
        // --- DOM元素 ---
        const sceneContainer = document.getElementById('scene-container');
        const instructionsPanel = document.getElementById('instructions');
        const settingsPanel = document.getElementById('settings-panel');
        const imageInput = document.getElementById('image-input');
        const uploadButton = document.getElementById('file-upload-button');
        const closeSettingsButton = document.getElementById('close-settings');
        const errorMessageDiv = document.getElementById('error-message');
        const grayscalePreviewCanvas = document.getElementById('grayscale-preview');
        // *** 更新预览画布的内部尺寸 ***
        grayscalePreviewCanvas.width = STREAM_WIDTH;
        grayscalePreviewCanvas.height = STREAM_HEIGHT;
        const grayscalePreviewCtx = grayscalePreviewCanvas.getContext('2d');
        const wsUrlInput = document.getElementById('ws-url-input');
        const wsStatusSpan = document.getElementById('ws-status');
        const wsConnectBtn = document.getElementById('ws-connect-btn');
        // --- 初始化函数 ---
        function init() {
            scene = new THREE.Scene();
            scene.background = new THREE.Color(0x111827);
            scene.fog = new THREE.Fog(0x111827, 0, 750);
            camera = new THREE.PerspectiveCamera(75, window.innerWidth / window.innerHeight, 0.1, 1000);
            camera.position.y = 10;
            renderer = new THREE.WebGLRenderer({ antialias: true, preserveDrawingBuffer: true });
            renderer.setSize(window.innerWidth, window.innerHeight);
            renderer.setPixelRatio(window.devicePixelRatio);
            sceneContainer.appendChild(renderer.domElement);
            ambientLight = new THREE.AmbientLight(0xffffff, 0.5);
            scene.add(ambientLight);
            directionalLight = new THREE.DirectionalLight(0xffffff, 1.5);
            directionalLight.position.set(50, 50, 50);
            scene.add(directionalLight);
            const floorGeometry = new THREE.PlaneGeometry(2000, 2000, 100, 100);
            const floorMaterial = new THREE.MeshLambertMaterial({ color: 0x808080 });
            floor = new THREE.Mesh(floorGeometry, floorMaterial);
            floor.rotation.x = -Math.PI / 2;
            scene.add(floor);
            controls = new PointerLockControls(camera, renderer.domElement);
            controls.addEventListener('lock', () => { instructionsPanel.style.display = 'none'; settingsPanel.style.display = 'none'; });
            controls.addEventListener('unlock', () => { if (!isSettingsOpen) instructionsPanel.style.display = 'block'; });
            scene.add(controls.getObject());
            window.addEventListener('resize', onWindowResize);
            document.addEventListener('keydown', onKeyDown);
            document.addEventListener('keyup', onKeyUp);
            sceneContainer.addEventListener('click', () => { if (!isSettingsOpen) controls.lock(); });
            setupUI();
        }
        // --- UI设置 ---
        let isSettingsOpen = false;
        function setupUI() {
            const tilingSlider = document.getElementById('tiling-slider');
            const fovSlider = document.getElementById('fov-slider');
            const lightSlider = document.getElementById('light-slider');
            const colorPicker = document.getElementById('color-picker');
            const tilingValue = document.getElementById('tiling-value');
            const fovValue = document.getElementById('fov-value');
            const lightValue = document.getElementById('light-value');
            uploadButton.addEventListener('click', () => imageInput.click());
            imageInput.addEventListener('change', (event) => {
                const file = event.target.files[0];
                if (file) {
                    const reader = new FileReader();
                    reader.onload = (e) => {
                        const loader = new THREE.TextureLoader();
                        loader.load(e.target.result, (texture) => {
                            floorTexture = texture;
                            floorTexture.wrapS = THREE.RepeatWrapping;
                            floorTexture.wrapT = THREE.RepeatWrapping;
                            floorTexture.anisotropy = renderer.capabilities.getMaxAnisotropy();
                            floorTexture.needsUpdate = true;
                            const tiling = parseInt(tilingSlider.value);
                            floorTexture.repeat.set(tiling, tiling);
                            floor.material.map = floorTexture;
                            floor.material.color.set(0xffffff);
                            floor.material.needsUpdate = true;
                            hideError();
                        }, undefined, (err) => showError('图片加载失败，请检查文件格式。'));
                    };
                    reader.readAsDataURL(file);
                }
            });
            document.addEventListener('keydown', (event) => { if (event.key.toLowerCase() === 'i') toggleSettingsPanel(); });
            closeSettingsButton.addEventListener('click', toggleSettingsPanel);
            tilingSlider.addEventListener('input', (e) => {
                const tiling = parseInt(e.target.value);
                tilingValue.textContent = tiling;
                if (floorTexture) floorTexture.repeat.set(tiling, tiling);
            });
            fovSlider.addEventListener('input', (e) => { camera.fov = parseInt(e.target.value); fovValue.textContent = camera.fov; camera.updateProjectionMatrix(); });
            lightSlider.addEventListener('input', (e) => { directionalLight.intensity = parseFloat(e.target.value); lightValue.textContent = directionalLight.intensity.toFixed(1); });
            colorPicker.addEventListener('input', (e) => { scene.background = new THREE.Color(e.target.value); scene.fog.color.set(scene.background); });
            // WebSocket UI Logic
            wsConnectBtn.addEventListener('click', () => {
                if (isStreaming) {
                    socket.close();
                } else {
                    try {
                        socket = new WebSocket(wsUrlInput.value);
                        wsStatusSpan.textContent = '连接中...';
                        wsStatusSpan.className = 'font-bold text-yellow-400';
                        socket.onopen = () => {
                            isStreaming = true;
                            grayscalePreviewCanvas.style.display = 'block';
                            wsStatusSpan.textContent = '已连接';
                            wsStatusSpan.className = 'font-bold text-green-400';
                            wsConnectBtn.textContent = '断开';
                            wsConnectBtn.className = 'w-full bg-red-600 hover:bg-red-700 text-white font-bold py-2 px-4 rounded-lg';
                        };
                        socket.onclose = () => {
                            isStreaming = false;
                            grayscalePreviewCanvas.style.display = 'none';
                            wsStatusSpan.textContent = '未连接';
                            wsStatusSpan.className = 'font-bold text-red-400';
                            wsConnectBtn.textContent = '连接';
                            wsConnectBtn.className = 'w-full bg-green-600 hover:bg-green-700 text-white font-bold py-2 px-4 rounded-lg';
                        };
                        socket.onerror = (error) => {
                            console.error('WebSocket Error:', error);
                            wsStatusSpan.textContent = '连接错误';
                            wsStatusSpan.className = 'font-bold text-red-400';
                        };
                    } catch (error) {
                         wsStatusSpan.textContent = 'URL无效';
                         console.error("Invalid WebSocket URL:", error);
                    }
                }
            });
        }
        function toggleSettingsPanel() {
            isSettingsOpen = !isSettingsOpen;
            settingsPanel.style.display = isSettingsOpen ? 'block' : 'none';
            instructionsPanel.style.display = isSettingsOpen ? 'none' : 'block';
            if (isSettingsOpen) controls.unlock();
        }
        function showError(message) { errorMessageDiv.textContent = message; errorMessageDiv.style.display = 'block'; }
        function hideError() { errorMessageDiv.style.display = 'none'; }
        function onWindowResize() {
            camera.aspect = window.innerWidth / window.innerHeight;
            camera.updateProjectionMatrix();
            renderer.setSize(window.innerWidth, window.innerHeight);
        }
        function onKeyDown(event) {
            switch (event.code) {
                case 'KeyW': moveState.forward = true; break; case 'KeyS': moveState.backward = true; break;
                case 'KeyA': moveState.left = true; break; case 'KeyD': moveState.right = true; break;
                case 'Space': moveState.up = true; break; case 'ShiftLeft': case 'ShiftRight': moveState.down = true; break;
            }
        }
        function onKeyUp(event) {
            switch (event.code) {
                case 'KeyW': moveState.forward = false; break; case 'KeyS': moveState.backward = false; break;
                case 'KeyA': moveState.left = false; break; case 'KeyD': moveState.right = false; break;
                case 'Space': moveState.up = false; break; case 'ShiftLeft': case 'ShiftRight': moveState.down = false; break;
            }
        }
        let prevTime = performance.now();
        function animate() {
            requestAnimationFrame(animate);
            const time = performance.now();
            const delta = (time - prevTime) / 1000;
            if (controls.isLocked) {
                velocity.x -= velocity.x * 10.0 * delta; velocity.z -= velocity.z * 10.0 * delta; velocity.y -= velocity.y * 10.0 * delta;
                direction.z = Number(moveState.forward) - Number(moveState.backward);
                direction.x = Number(moveState.right) - Number(moveState.left);
                direction.y = Number(moveState.up) - Number(moveState.down);
                direction.normalize();
                if (moveState.forward || moveState.backward) velocity.z -= direction.z * moveSpeed * delta;
                if (moveState.left || moveState.right) velocity.x -= direction.x * moveSpeed * delta;
                if (moveState.up || moveState.down) velocity.y += direction.y * moveSpeed * delta;
                controls.moveRight(-velocity.x * delta);
                controls.moveForward(-velocity.z * delta);
                controls.getObject().position.y += velocity.y * delta;
            }
            renderer.render(scene, camera);
            // --- 数据流处理 ---
            if (isStreaming && socket.readyState === WebSocket.OPEN) {
                // 1. 将3D场景画布内容绘制到处理画布上
                processCtx.drawImage(renderer.domElement, 0, 0, STREAM_WIDTH, STREAM_HEIGHT);
                // 2. 获取像素数据
                const imageData = processCtx.getImageData(0, 0, STREAM_WIDTH, STREAM_HEIGHT);
                const data = imageData.data;
                // *** 更新数据缓冲区大小 ***
                const grayscaleData = new Uint8ClampedArray(STREAM_WIDTH * STREAM_HEIGHT);
                // 3. 转换为灰度图
                for (let i = 0; i < data.length; i += 4) {
                    const r = data[i]; const g = data[i + 1]; const b = data[i + 2];
                    const gray = 0.299 * r + 0.587 * g + 0.114 * b;
                    grayscaleData[i / 4] = gray;
                    // 同时更新ImageData用于预览
                    data[i] = data[i + 1] = data[i + 2] = gray;
                }
                // 4. 发送灰度数据
                socket.send(grayscaleData.buffer);
                // 5. 更新右下角的预览画布
                grayscalePreviewCtx.putImageData(imageData, 0, 0);
            }
            prevTime = time;
        }
        init();
        animate();
    </script>
</body>
</html>
